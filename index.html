<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZapZap Speedtest Website</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="logo">⚡ ZapZap</div>
        <div class="subtitle">High-Speed Internet Test Website</div>
        
        <div class="test-area">
            <div id="speedDisplay" class="speedometer-container">
                <div class="speedometer">
                    <div class="speedometer-inner">
                        <div class="speedometer-needle" id="speedometerNeedle"></div>
                        <div class="speedometer-center"></div>
                    </div>
                    <div class="speedometer-labels">
                        <span class="label-0">0</span>
                        <span class="label-50">50</span>
                        <span class="label-100">100</span>
                        <span class="label-150">150</span>
                        <span class="label-200">200</span>
                        <span class="label-250">250</span>
                        <span class="label-300">300</span>
                    </div>
                </div>
                <div class="speed-display">
                    <span id="speedValue">0</span>
                    <span class="unit">Mbps</span>
                </div>
            </div>
            
            <div id="status" class="status info">🚀 Click Start to begin your speed test</div>
            
            <div id="progressContainer" class="progress-container hidden">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            
            <button id="startTest" class="test-button">Start Speed Test</button>
            <button id="stopTest" class="test-button" disabled>Stop Test</button>
        </div>

        <div id="results" class="results hidden">
            <h3>Test Results</h3>
            <div id="resultContent"></div>
        </div>

        <div id="errorContainer" class="hidden">
            <div id="errorMessage" class="error-message"></div>
        </div>
    </div>

    <script src="zap.js"></script>
    <script>
        class ZapZapSpeedTestUI {
            constructor() {
                this.tester = null;
                this.isRunning = false;
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.startBtn = document.getElementById('startTest');
                this.stopBtn = document.getElementById('stopTest');
                this.status = document.getElementById('status');
                this.progressContainer = document.getElementById('progressContainer');
                this.progressBar = document.getElementById('progressBar');
                this.speedDisplay = document.getElementById('speedDisplay');
                this.speedValue = document.getElementById('speedValue');
                this.results = document.getElementById('results');
                this.resultContent = document.getElementById('resultContent');
                this.errorContainer = document.getElementById('errorContainer');
                this.errorMessage = document.getElementById('errorMessage');
            }

            bindEvents() {
                this.startBtn.addEventListener('click', () => {
                    console.log('Start button clicked!');
                    this.startTest();
                });
                this.stopBtn.addEventListener('click', () => {
                    console.log('Stop button clicked!');
                    this.stopTest();
                });
            }

            showStatus(message, type = 'info') {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
                this.status.classList.remove('hidden');
            }

            showError(message) {
                this.errorMessage.textContent = message;
                this.errorContainer.classList.remove('hidden');
                this.results.classList.add('hidden');
            }

            hideError() {
                this.errorContainer.classList.add('hidden');
            }

            updateProgress(progress) {
                console.log('Progress:', progress);
                
                if (progress.stage === 'complete') {
                    this.isRunning = false;
                    this.startBtn.disabled = false;
                    this.startBtn.textContent = 'Start Speed Test';
                    this.stopBtn.disabled = true;
                    this.progressContainer.classList.add('hidden');
                    this.displayResults(progress.result);
                    return;
                }
                
                if (progress.stage === 'error') {
                    this.isRunning = false;
                    this.startBtn.disabled = false;
                    this.startBtn.textContent = 'Start Speed Test';
                    this.stopBtn.disabled = true;
                    this.progressContainer.classList.add('hidden');
                    this.showError(progress.message);
                    return;
                }
                
                this.progressContainer.classList.remove('hidden');
                this.progressBar.style.width = '100%';
                
                // Update status message with progress message if available
                if (progress.message) {
                    this.status.textContent = progress.message;
                } else {
                    const statusMessages = {
                        'ip': '🌐 Detecting IP address...',
                        'ping': '🏓 Testing latency...',
                        'download': '⬇️ Testing download speed...',
                        'upload': '⬆️ Testing upload speed...'
                    };
                    this.status.textContent = statusMessages[progress.stage] || 'Testing...';
                }
                this.status.className = 'status info';
            }

            updateSpeed(mbps) {
                this.speedValue.textContent = mbps.toFixed(1);
                this.speedDisplay.classList.remove('hidden');
                this.animateSpeedometer(mbps);
            }

            resetSpeedometer() {
                const needle = document.getElementById('speedometerNeedle');
                if (!needle) return;

                // Reset to 0 position with smooth animation
                needle.style.transform = 'rotate(-90deg)';
                needle.style.background = 'linear-gradient(to bottom, #2c3e50, #34495e, #7f8c8d)';
                needle.style.transition = 'transform 1s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                
                // Reset speed display
                this.speedValue.textContent = '0';
                this.speedValue.style.color = '#667eea';
            }

            startSpeedometerTest() {
                const needle = document.getElementById('speedometerNeedle');
                if (!needle) return;

                // Start testing animation - needle moves back and forth
                needle.style.transition = 'transform 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
                needle.style.background = 'linear-gradient(to bottom, #667eea, #764ba2, #f093fb)';
                
                // Animate needle during test with realistic speed range
                this.testingInterval = setInterval(() => {
                    // Random speed between 0-300 Mbps
                    const randomSpeed = Math.random() * 300;
                    const percentage = randomSpeed / 300;
                    const randomAngle = -90 + (percentage * 180);
                    needle.style.transform = `rotate(${randomAngle}deg)`;
                }, 400);
            }

            stopSpeedometerTest() {
                if (this.testingInterval) {
                    clearInterval(this.testingInterval);
                    this.testingInterval = null;
                }
            }

            animateSpeedometer(mbps) {
                const needle = document.getElementById('speedometerNeedle');
                if (!needle) return;

                // Stop testing animation
                this.stopSpeedometerTest();

                // Convert Mbps to degrees (0-300 Mbps range)
                // -90deg to 90deg rotation (180 degrees total)
                // 0 Mbps = -90deg (left), 150 Mbps = 0deg (top), 300 Mbps = 90deg (right)
                const maxSpeed = 300;
                const clampedSpeed = Math.min(mbps, maxSpeed);
                const percentage = clampedSpeed / maxSpeed;
                const degrees = -90 + (percentage * 180);
                
                console.log(`Speed: ${mbps} Mbps, Percentage: ${(percentage * 100).toFixed(1)}%, Degrees: ${degrees.toFixed(1)}°`);
                
                // Smooth animation to final position
                needle.style.transition = 'transform 2s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                needle.style.transform = `rotate(${degrees}deg)`;
                
                // Change color based on speed with modern gradients
                if (mbps < 25) {
                    needle.style.background = 'linear-gradient(to bottom, #ff4757, #ff6b35)';
                } else if (mbps < 50) {
                    needle.style.background = 'linear-gradient(to bottom, #ff6b35, #feca57)';
                } else if (mbps < 100) {
                    needle.style.background = 'linear-gradient(to bottom, #feca57, #48dbfb)';
                } else if (mbps < 150) {
                    needle.style.background = 'linear-gradient(to bottom, #48dbfb, #0abde3)';
                } else if (mbps < 200) {
                    needle.style.background = 'linear-gradient(to bottom, #0abde3, #006ba6)';
                } else {
                    needle.style.background = 'linear-gradient(to bottom, #006ba6, #3742fa)';
                }

                // Add final bounce effect
                setTimeout(() => {
                    needle.style.transition = 'transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                    const bounceAngle = degrees + (Math.random() - 0.5) * 3;
                    needle.style.transform = `rotate(${bounceAngle}deg)`;
                    
                    setTimeout(() => {
                        needle.style.transform = `rotate(${degrees}deg)`;
                    }, 300);
                }, 2000);
            }

            displayResults(result) {
                const content = `
                    <div class="result-item">
                        <span class="result-label">Download Speed:</span>
                        <span class="result-value">${result.download.mbps.toFixed(1)} Mbps</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Upload Speed:</span>
                        <span class="result-value">${result.upload.mbps.toFixed(1)} Mbps</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Ping:</span>
                        <span class="result-value">${result.ping.avgMs.toFixed(0)} ms</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">IP Address:</span>
                        <span class="result-value">${result.ip.ip || 'N/A'}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ISP:</span>
                        <span class="result-value">${result.ip.isp || 'N/A'}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Test Time:</span>
                        <span class="result-value">${new Date(result.timestamp).toLocaleString()}</span>
                    </div>
                `;
                this.resultContent.innerHTML = content;
                this.results.classList.remove('hidden');
            }

            async startTest() {
                if (this.isRunning) return;

                this.isRunning = true;
                this.startBtn.disabled = true;
                this.startBtn.textContent = 'Start Speed Test'; // Reset button text
                this.stopBtn.disabled = false;
                this.hideError();
                this.results.classList.add('hidden');
                this.speedDisplay.classList.remove('hidden');
                this.progressContainer.classList.add('hidden');
                
                // Reset speedometer and start testing animation
                this.resetSpeedometer();
                this.startSpeedometerTest();

                // Use sensible defaults for better user experience
                const urlCount = 6; // Good balance of accuracy and speed
                const measureUpload = true; // Always test upload for complete results

                this.tester = new window.ZapZapSpeedTest({
                    uploadSize: 256 * 1024, // 256KB (faster testing)
                    downloadSize: 2, // 2MB (faster testing)
                    pingSamples: 3 // 3 samples (faster)
                });

                try {
                    this.showStatus('🚀 Initializing speed test...', 'info');
                    
                    const result = await this.tester.run({
                        onProgress: (progress) => {
                            this.handleProgress(progress);
                        }
                    });

                    this.displayResults(result);
                    this.updateSpeed(result.download.mbps);
                    this.showStatus('Speed test completed successfully!', 'success');
                    
                } catch (error) {
                    console.error('Speed test error:', error);
                    this.showError(`Speed test failed: ${error.message}`);
                    this.showStatus('❌ Speed test failed - Click Start to try again', 'error');
                    
                    // Add retry button
                    this.startBtn.textContent = '🔄 Retry Speed Test';
                } finally {
                    this.isRunning = false;
                    this.startBtn.disabled = false;
                    this.stopBtn.disabled = true;
                    this.progressContainer.classList.add('hidden');
                }
            }

            handleProgress(progress) {
                console.log('Progress:', progress);
                
                switch (progress.stage) {
                    case 'ip':
                        this.showStatus('🌐 Getting IP address...', 'info');
                        break;
                    case 'ping':
                        this.showStatus('📡 Measuring ping (3 samples)...', 'info');
                        break;
                    case 'download':
                        this.showStatus('⬇️ Testing download speed (2MB)...', 'info');
                        this.progressContainer.classList.remove('hidden');
                        break;
                    case 'upload':
                        this.showStatus('⬆️ Testing upload speed (256KB)...', 'info');
                        break;
                    case 'complete':
                        this.showStatus('🎉 Speed test completed!', 'success');
                        this.progressContainer.classList.add('hidden');
                        break;
                }
            }

            stopTest() {
                if (this.tester) {
                    this.tester.cancel();
                }
                this.isRunning = false;
                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
                this.showStatus('Test stopped by user', 'info');
                this.progressContainer.classList.add('hidden');
                
                // Stop speedometer testing animation
                this.stopSpeedometerTest();
                this.resetSpeedometer();
            }

        }

        // Initialize the speed test app
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing ZapZap SpeedTest...');
            console.log('ZapZapSpeedTest available:', typeof window.ZapZapSpeedTest);
            console.log('window.ZapZapSpeedTest:', window.ZapZapSpeedTest);
            console.log('testZapZapSpeedTest available:', typeof window.testZapZapSpeedTest);
            if (typeof window.testZapZapSpeedTest === 'function') {
                console.log('Test function result:', window.testZapZapSpeedTest());
            }
            console.log('All window properties:', Object.keys(window).filter(k => k.includes('ZapZap') || k.includes('Speed')));
            
            // Wait a bit for script to load
            setTimeout(() => {
                if (typeof window.ZapZapSpeedTest === 'undefined') {
                    console.error('ZapZapSpeedTest not loaded! Check if zap.js is loading correctly.');
                    console.log('Available window properties:', Object.keys(window).filter(k => k.includes('ZapZap') || k.includes('Speed')));
                    alert('Error: ZapZapSpeedTest not loaded. Please check the browser console for details.');
                    return;
                }
                
                new ZapZapSpeedTestUI();
            }, 100);
        });
    </script>
</body>
</html>
