<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZapZap Speedtest Website</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="logo">‚ö° ZapZap</div>
        <div class="subtitle">High-Speed Internet Test Website</div>
        
        <div class="test-area">
            <div id="speedDisplay" class="speedometer-container">
                <div class="speedometer">
                    <div class="speedometer-inner">
                        <div class="speedometer-needle" id="speedometerNeedle"></div>
                        <div class="speedometer-center"></div>
                    </div>
                    <div class="speedometer-labels">
                        <span class="label-0">0</span>
                        <span class="label-25">25</span>
                        <span class="label-50">50</span>
                        <span class="label-75">75</span>
                        <span class="label-100">100</span>
                        <span class="label-125">125</span>
                        <span class="label-150">150</span>
                        <span class="label-200">200</span>
                    </div>
                </div>
                <div class="speed-display">
                    <span id="speedValue">0</span>
                    <span class="unit">Mbps</span>
                </div>
            </div>
            
            <div id="status" class="status info">üöÄ Click Start to begin your speed test</div>
            
            <div id="progressContainer" class="progress-container hidden">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            
            <button id="startTest" class="test-button">Start Speed Test</button>
            <button id="stopTest" class="test-button" disabled>Stop Test</button>
        </div>

        <div id="results" class="results hidden">
            <h3>Test Results</h3>
            <div id="resultContent"></div>
        </div>

        <div id="errorContainer" class="hidden">
            <div id="errorMessage" class="error-message"></div>
        </div>
    </div>

    <script src="zap.js"></script>
    <script>
        class ZapZapSpeedTest {
            constructor() {
                this.tester = null;
                this.isRunning = false;
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.startBtn = document.getElementById('startTest');
                this.stopBtn = document.getElementById('stopTest');
                this.status = document.getElementById('status');
                this.progressContainer = document.getElementById('progressContainer');
                this.progressBar = document.getElementById('progressBar');
                this.speedDisplay = document.getElementById('speedDisplay');
                this.speedValue = document.getElementById('speedValue');
                this.results = document.getElementById('results');
                this.resultContent = document.getElementById('resultContent');
                this.errorContainer = document.getElementById('errorContainer');
                this.errorMessage = document.getElementById('errorMessage');
            }

            bindEvents() {
                this.startBtn.addEventListener('click', () => {
                    console.log('Start button clicked!');
                    this.startTest();
                });
                this.stopBtn.addEventListener('click', () => {
                    console.log('Stop button clicked!');
                    this.stopTest();
                });
            }

            showStatus(message, type = 'info') {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
                this.status.classList.remove('hidden');
            }

            showError(message) {
                this.errorMessage.textContent = message;
                this.errorContainer.classList.remove('hidden');
                this.results.classList.add('hidden');
            }

            hideError() {
                this.errorContainer.classList.add('hidden');
            }

            updateProgress(progress) {
                console.log('Progress:', progress);
                
                if (progress.stage === 'complete') {
                    this.isRunning = false;
                    this.startBtn.disabled = false;
                    this.startBtn.textContent = 'Start Speed Test';
                    this.stopBtn.disabled = true;
                    this.progressContainer.classList.add('hidden');
                    this.displayResults(progress.result);
                    return;
                }
                
                if (progress.stage === 'error') {
                    this.isRunning = false;
                    this.startBtn.disabled = false;
                    this.startBtn.textContent = 'Start Speed Test';
                    this.stopBtn.disabled = true;
                    this.progressContainer.classList.add('hidden');
                    this.showError(progress.message);
                    return;
                }
                
                this.progressContainer.classList.remove('hidden');
                this.progressBar.style.width = '100%';
                
                // Update status message with progress message if available
                if (progress.message) {
                    this.status.textContent = progress.message;
                } else {
                    const statusMessages = {
                        'ip': 'üåê Detecting IP address...',
                        'ping': 'üèì Testing latency...',
                        'download': '‚¨áÔ∏è Testing download speed...',
                        'upload': '‚¨ÜÔ∏è Testing upload speed...'
                    };
                    this.status.textContent = statusMessages[progress.stage] || 'Testing...';
                }
                this.status.className = 'status info';
            }

            updateSpeed(mbps) {
                this.speedValue.textContent = mbps.toFixed(1);
                this.speedDisplay.classList.remove('hidden');
                this.animateSpeedometer(mbps);
            }

            resetSpeedometer() {
                const needle = document.getElementById('speedometerNeedle');
                if (!needle) return;

                // Reset to 0 position
                needle.style.transform = 'rotate(-90deg)';
                needle.style.background = 'linear-gradient(to bottom, #333, #666)';
                needle.style.transition = 'transform 0.5s ease-out';
                
                // Reset speed display
                this.speedValue.textContent = '0';
            }

            animateSpeedometer(mbps) {
                const needle = document.getElementById('speedometerNeedle');
                if (!needle) return;

                // Convert Mbps to degrees (0-200 Mbps range)
                // -90deg to 90deg rotation (180 degrees total)
                const maxSpeed = 200;
                const clampedSpeed = Math.min(mbps, maxSpeed);
                const percentage = clampedSpeed / maxSpeed;
                const degrees = -90 + (percentage * 180);
                
                needle.style.transform = `rotate(${degrees}deg)`;
                
                // Add a little bounce effect
                needle.style.transition = 'transform 1s cubic-bezier(0.4, 0, 0.2, 1)';
                
                // Change needle color based on speed
                if (mbps < 25) {
                    needle.style.background = 'linear-gradient(to bottom, #ff4444, #ff6666)';
                } else if (mbps < 50) {
                    needle.style.background = 'linear-gradient(to bottom, #ffaa44, #ffcc66)';
                } else if (mbps < 100) {
                    needle.style.background = 'linear-gradient(to bottom, #ffdd44, #ffee66)';
                } else if (mbps < 150) {
                    needle.style.background = 'linear-gradient(to bottom, #aaff44, #ccff66)';
                } else {
                    needle.style.background = 'linear-gradient(to bottom, #44ff44, #66ff66)';
                }
            }

            displayResults(result) {
                const content = `
                    <div class="result-item">
                        <span class="result-label">Download Speed:</span>
                        <span class="result-value">${result.download.mbps.toFixed(1)} Mbps</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Upload Speed:</span>
                        <span class="result-value">${result.upload.mbps.toFixed(1)} Mbps</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Ping:</span>
                        <span class="result-value">${result.ping.avgMs.toFixed(0)} ms</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">IP Address:</span>
                        <span class="result-value">${result.ip.ip || 'N/A'}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ISP:</span>
                        <span class="result-value">${result.ip.isp || 'N/A'}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Test Time:</span>
                        <span class="result-value">${new Date(result.timestamp).toLocaleString()}</span>
                    </div>
                `;
                this.resultContent.innerHTML = content;
                this.results.classList.remove('hidden');
            }

            async startTest() {
                if (this.isRunning) return;

                this.isRunning = true;
                this.startBtn.disabled = true;
                this.startBtn.textContent = 'Start Speed Test'; // Reset button text
                this.stopBtn.disabled = false;
                this.hideError();
                this.results.classList.add('hidden');
                this.speedDisplay.classList.remove('hidden');
                this.progressContainer.classList.add('hidden');
                
                // Reset speedometer
                this.resetSpeedometer();

                // Use sensible defaults for better user experience
                const urlCount = 6; // Good balance of accuracy and speed
                const measureUpload = true; // Always test upload for complete results

                this.tester = new window.LibreSpeed({
                    uploadSize: 256 * 1024, // 256KB (faster testing)
                    downloadSize: 2, // 2MB (faster testing)
                    pingSamples: 3 // 3 samples (faster)
                });

                try {
                    this.showStatus('üöÄ Initializing speed test...', 'info');
                    
                    const result = await this.tester.run({
                        onProgress: (progress) => {
                            this.handleProgress(progress);
                        }
                    });

                    this.displayResults(result);
                    this.updateSpeed(result.download.mbps);
                    this.showStatus('Speed test completed successfully!', 'success');
                    
                } catch (error) {
                    console.error('Speed test error:', error);
                    this.showError(`Speed test failed: ${error.message}`);
                    this.showStatus('‚ùå Speed test failed - Click Start to try again', 'error');
                    
                    // Add retry button
                    this.startBtn.textContent = 'üîÑ Retry Speed Test';
                } finally {
                    this.isRunning = false;
                    this.startBtn.disabled = false;
                    this.stopBtn.disabled = true;
                    this.progressContainer.classList.add('hidden');
                }
            }

            handleProgress(progress) {
                console.log('Progress:', progress);
                
                switch (progress.stage) {
                    case 'ip':
                        this.showStatus('üåê Getting IP address...', 'info');
                        break;
                    case 'ping':
                        this.showStatus('üì° Measuring ping (3 samples)...', 'info');
                        break;
                    case 'download':
                        this.showStatus('‚¨áÔ∏è Testing download speed (2MB)...', 'info');
                        this.progressContainer.classList.remove('hidden');
                        break;
                    case 'upload':
                        this.showStatus('‚¨ÜÔ∏è Testing upload speed (256KB)...', 'info');
                        break;
                    case 'complete':
                        this.showStatus('üéâ Speed test completed!', 'success');
                        this.progressContainer.classList.add('hidden');
                        break;
                }
            }

            stopTest() {
                if (this.tester) {
                    this.tester.cancel();
                }
                this.isRunning = false;
                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
                this.showStatus('Test stopped by user', 'info');
                this.progressContainer.classList.add('hidden');
            }

        }

        // Initialize the speed test app
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing ZapZap SpeedTest...');
            console.log('LibreSpeed available:', typeof window.LibreSpeed);
            console.log('window.LibreSpeed:', window.LibreSpeed);
            console.log('testLibreSpeed available:', typeof window.testLibreSpeed);
            if (typeof window.testLibreSpeed === 'function') {
                console.log('Test function result:', window.testLibreSpeed());
            }
            console.log('All window properties:', Object.keys(window).filter(k => k.includes('Libre') || k.includes('Speed')));
            
            // Wait a bit for script to load
            setTimeout(() => {
                if (typeof window.LibreSpeed === 'undefined') {
                    console.error('LibreSpeed not loaded! Check if zap.js is loading correctly.');
                    console.log('Available window properties:', Object.keys(window).filter(k => k.includes('Libre') || k.includes('Speed')));
                    alert('Error: LibreSpeed not loaded. Please check the browser console for details.');
                    return;
                }
                
                new ZapZapSpeedTest();
            }, 100);
        });
    </script>
</body>
</html>
